<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bgtlover"><meta name=keywords content="hacks notifications rust zbus "><meta name=description content="ever since the first release, things appeared to be quite stagnant, especially from the outside. This is not an imagination of the public, this is actually true, things were quite stagnant for a while, mostly because a lot of the team was busy with real life situations. However, it appears that we have a bit more time now, so what better way to communicate this than sharing the fun with everyone, as well as, of course, the latest feature we were working on?"><meta name=theme-color media="(prefers-color-scheme: light)" content="white"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#141414"><link rel=license type=text/html href=https://www.gnu.org/licenses/agpl-3.0-standalone.html><link rel=license type=text/html href=https://creativecommons.org/licenses/by-sa/4.0/><link rel=stylesheet type=text/css href=/css/style.css encoding=UTF-8><link rel=stylesheet type=text/css href=/css/syntax.css encoding=UTF-8><title>Going The Way Of the Notifications | Odilia Screen Reader</title></head><body><div id=container><nav class=global-nav><ul class=nav-list><li class=nav-item><a href=/ class=nav-link>Home</a></li><li class=nav-item><a href=/news/ class="nav-link active" aria-current=true>News</a></li><li class=nav-item><a href=/design/ class=nav-link>Design</a></li><li class=nav-item><a href=/doc/ class=nav-link>Documentation</a></li><li class=nav-item><a href=/community/ class=nav-link>Community</a></li><li class=nav-item><a href=https://github.com/odilia-app class=nav-link>Code</a></li></ul></nav><main><article><header><h1>Going The Way Of the Notifications</h1><small>Published on <time datetime=2024-03-03>March 3, 2024</time>
by <a href=https://odilia.app/authors/bgtlover/>bgtlover</a>&#183; 8 minutes read<br><nav aria-label="Post tags"><a href=https://odilia.app/tags/hacks/>hacks</a> &#183; <a href=https://odilia.app/tags/notifications/>notifications</a> &#183; <a href=https://odilia.app/tags/rust/>rust</a> &#183; <a href=https://odilia.app/tags/zbus/>zbus</a></nav></small></header><p>ever since the <a href=/news/release_0-1-0/>first release</a>, things appeared to be quite stagnant, especially from the outside. This is not an imagination of the public, this is actually true, things were quite stagnant for a while, mostly because a lot of the team was busy with real life situations. However, it appears that we have a bit more time now, so what better way to communicate this than sharing the fun with everyone, as well as, of course, the latest feature we were working on?</p><h2 id=introducing-notifications>introducing notifications</h2><p>Notifications are the unsung heroes of a seamless desktop experience across Linux, Windows, macOS, or even smartphones. We need to stay informed about events happening around us, and traditionally, this is achieved through small pop-ups, help balloons (as Windows 7 and earlier versions called them), or tooltips that appear on the edge of our screen, alerting us to events, even when the originating application isn&rsquo;t in focus.
However, there&rsquo;s a catch:</p><p>I don&rsquo;t know about other operating systems, but linux doesn&rsquo;t offer an accessibility focused API to get most system related events, and this includes notifications. Given this, and considering the critical nature of this feature, we&rsquo;re left with no choice but to&mldr;</p><h2 id=diving-into-the-hacks>Diving into the Hacks</h2><p>In response to the absence of an accessibility dedicated API for system information in the freedesktop stack, various hacks have emerged over time. Our approach, while different in execution, isn&rsquo;t too far off.</p><p>In the following, we will describe the hack used by orca, since this is the only one known to do this, along with the reason we didn&rsquo;t do it this way. Afterwards, we will document, briefly, our own hack and why we chose this method instead</p><p>Warning: This section is quite technical. If you&rsquo;re not technically inclined, feel free to <a href=#limitations>skip to the limitations section</a></p><h3 id=orcas-hack>orca&rsquo;s hack</h3><p>the approach of orca is as simple as it is effective:</p><p>Most notification daemons, at least back in the day this hack was made, created a new window, with the role of alert whenever a new notification appeared. So then, that&rsquo;s exactly what orca does to read them. It monitors the accessibility bus for a window appeared event, it extracts the window title, and then it realises/dereferences the sender to see if it&rsquo;s an accessible application, and if so, if the root has the role alert. If all of those are true, the notification text is either in the window title, or in a text element which is typically the first such element in the hierarchy of accessibles from that root. The others may or may not be action buttons and other things, but that&rsquo;s not important to orca, so that stuff is ignored.</p><p>there are afew problems with this design though, and that&rsquo;s why we were not going to use it:</p><ul><li>this only works if the notification daemon playes by those rules, and by that I mean presenting the notification in exactly that manner. Sure, many of them do, especially those of gnome and kde, but that&rsquo;s because they are well aware of the situation and they implemented it in such a way that orca can use it. Other daemons, for example dunst and others, typically used in a window-manager only setup, don&rsquo;t do that. They can be coded to do it, sure, but then it might break their own way of presentation</li><li>orca relies on presentation, which is known to be unstable, far more unstable than protocols. Sure, people might say that such a model of presentation will not be changed once the maintainers of the projects know that an accessibility software relies on that, but that doesn&rsquo;t make this method any less fragile</li><li>we see apps become inaccessible from almost perfectly accessible a lot, especially from people who don&rsquo;t know anything about accessibility and who made a UI which just happens to be accessible back then. However, this absolutely can&rsquo;t happen for something like notifications, or other ways of reporting important system events. It is the projects maintainers responsability, to some degree, to make sure that once they know a behaviour is relied on by people, especially people who can&rsquo;t use their software without that aka accessibility, it&rsquo;s not broken in subsequent builds or feature changes, the don&rsquo;t break userspace daugma is as important in certain userspace system-level or desktop-level components as it is for the kernel. However, we as screenreader developers, also have a responsability to our users, to keep things as far from breaking as possible, and relying on presentation details, when something, anything better is available, is just setting our users up for greef when that breakage eventually happens, or when a component in the chosen user configuration ends up not playing by the rules outlined above</li></ul><p>there&rsquo;s another reason for which we&rsquo;re not using this method, and it has nothing to do with limitations or design defficiencies in the previously outlined algorythm.</p><p>because odilia is a very young project, and furthermore is actively under development, well, more like on and off but still, we don&rsquo;t currently have the mechanisms required to handle that event, filter based on it, extract information from it, etc. We do for focus and others, but because we don&rsquo;t for this one, we felt it would be too much work across a longer time frame for not enough benefit currently.</p><h3 id=our-hack>our hack</h3><p>our hack relies on the <a href=https://specifications.freedesktop.org/notification-spec/notification-spec-latest.html>freedesktop notifications specification</a> to be relevant and implemented by notification daemons, and is unfortunately not as simple as the one implemented by orca, but we believe it could be a bit more resiliant to change in presentation, because of the protocol itself if nothing else. It goes as follows:</p><ul><li>monitor the session bus for a message of type method call, using the <a href=https://docs.rs/zbus/latest/zbus/fdo/struct.MonitoringProxy.html>zbus::fdo::MonitoringProxy</a> type</li><li>map over the created stream, to convert the messages to a notification object we define earlier. This contains title, body and application_name, the rest are ignored</li><li>iterate over the thusly obtained new stream, and speak each notification as it comes in</li></ul><p>this approach has afew advantages compared to the previous one:</p><ul><li>we don&rsquo;t rely on presentation. Each notification daemon can present things however it wants on screen, as long as it uses the standard notification specification. Therefore, people can use any notification daemon they want, and that includes obscure ones used in very minimalist setups</li><li>as long as the protocol remains relevant, or is used anywhere in the backend for us to be able to monitor the messages, this method will continue to function</li></ul><p>there are, however, disadvantages with this one as well, but for the time being, we believe them to not be big enough when ballanced with not having the feature at all:</p><ul><li>monitoring: we are well aware sniffing the bus is not accepted as a good thing to do, and we believe we may have problems with packaging systems in the future because of this, for example flatpak. It should be only used as a development and debugging tool, we do know that, and we advice everyone who wants to do what we did to&mldr;not do it, unless there&rsquo;s really no way around it, but even then, think thrice at least before doing so. However, unfortunately, accessibility has to be an exception to certain things because of the &ldquo;nature of the beast&rdquo; so to speak, so in absence of anything better, we believe this is the less of all possible evils</li></ul><h2 id=limitations>limitations</h2><p>currently, we can&rsquo;t reliably extract the source of the notification, because most apps we tryed this with sent an empty response for that part. So, for now, odilia only says new notification, in stead of saying from which app that notification came.</p><p>We do intend to fix this in the future, if a reliable method to find that information will be discovered, we hope this will not remain broken forever. If anyone knows anything, feel free to <a href=/community/>contact us</a>.</p><h2 id=how-to-try-it>how to try it</h2><p>you just clone the repository, then run it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone https://github.com/odilia-app/odilia
</span></span><span class=line><span class=cl>cargo install --path .
</span></span><span class=line><span class=cl>odilia
</span></span></code></pre></td></tr></table></div></div><p>if you&rsquo;re running from a release, why would you be doing that anyway, since this is such an alpha software? you just pull main again, install and run the new version:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git checkout main
</span></span><span class=line><span class=cl>git pull
</span></span><span class=line><span class=cl>cargo install --path .
</span></span><span class=line><span class=cl>odilia
</span></span></code></pre></td></tr></table></div></div><p>for more information, refere to the <a href=/doc/user/installation/>installation guide</a></p><h2 id=possible-issues>possible issues</h2><ul><li>on the gnome desktop, notifications might be heard twice, or in rare circumstances, not at all. This has been confirmed to happen once with notify-send, and might be inaccurate. If this is reproduceable every time, and especially if it&rsquo;s so with other desktops, feel free to get in touch because surely there&rsquo;s a way to get it fixed</li><li>in certain cases, odilia might not exit properly when sending it a sigint, or in other words, pressing ctrl+c while it has terminal focus. If this happens to you, please do get in touch</li></ul><h2 id=conclusion>conclusion</h2><p>it has certainly been a very fun couple of days, or maybe weeks at this point, polishing everything and making sure it&rsquo;s as good as possible in these conditions. Making this feature a reality took about two pull requests, if not three, working on different parts of the stack, to make sure tests correctly pass, no false negatives prevent us from merging, and actual bugs are caught instead. Hell, we did hit a very interesting exception case, which could make odilia hang on exit, and despite our efforts, may still make it do so.</p><p>many things were learned as well, especially about some previously unknown dbus mechanisms, the freedesktop notifications specification, github workflow quirks, believe it or not but x11 virtual framebuffers, and we might be missing something, but it was certainly very much fun.</p><p>Now, it&rsquo;s your turn to have fun! Run the new build, test it some more, lament at how weird everything is, but most important, we would be thrilled if you would talk to us about it!</p><p>as always, you are a big reason for which we keep developing odilia. Stay safe, and don&rsquo;t forget, you are a big force in helping us revolutionise the linux desktop, one step at a time!</p></article></main><footer id=footer>Copyright &copy; 2024
<a href=https://github.com/orgs/odilia-app/people target=_blank>the Odilia developers</a>
(Code is <a rel=license href=https://www.gnu.org/licenses/agpl-3.0-standalone.html target=blank>AGPL 3</a>,
content is <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/ target=blank>CC-BY-SA 4.0</a>)</footer></div></body></html>